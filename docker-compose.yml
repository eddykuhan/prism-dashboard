version: '3.8'

services:
  # Local DynamoDB for development
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: prism-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - dynamodb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000/shell/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # DynamoDB Admin UI (optional, for debugging)
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: prism-dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      - DYNAMO_ENDPOINT=http://dynamodb-local:8000
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
    depends_on:
      dynamodb-local:
        condition: service_healthy

  # Initialize DynamoDB tables
  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: prism-dynamodb-init
    depends_on:
      dynamodb-local:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: >
      /bin/sh -c "
        echo 'Creating DynamoDB tables...'
        
        # Create logs table
        aws dynamodb create-table \
          --table-name prism-logs \
          --attribute-definitions \
            AttributeName=ServiceName,AttributeType=S \
            AttributeName=TimestampNs,AttributeType=N \
          --key-schema \
            AttributeName=ServiceName,KeyType=HASH \
            AttributeName=TimestampNs,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'Logs table already exists'

        # Create metrics table
        aws dynamodb create-table \
          --table-name prism-metrics \
          --attribute-definitions \
            AttributeName=ServiceName,AttributeType=S \
            AttributeName=TimestampNs,AttributeType=N \
          --key-schema \
            AttributeName=ServiceName,KeyType=HASH \
            AttributeName=TimestampNs,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'Metrics table already exists'

        # Create traces table
        aws dynamodb create-table \
          --table-name prism-traces \
          --attribute-definitions \
            AttributeName=TraceId,AttributeType=S \
            AttributeName=SpanId,AttributeType=S \
          --key-schema \
            AttributeName=TraceId,KeyType=HASH \
            AttributeName=SpanId,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'Traces table already exists'

        # Enable TTL on tables
        aws dynamodb update-time-to-live \
          --table-name prism-logs \
          --time-to-live-specification 'Enabled=true,AttributeName=TTL' \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'TTL already enabled on logs'

        aws dynamodb update-time-to-live \
          --table-name prism-metrics \
          --time-to-live-specification 'Enabled=true,AttributeName=TTL' \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'TTL already enabled on metrics'

        aws dynamodb update-time-to-live \
          --table-name prism-traces \
          --time-to-live-specification 'Enabled=true,AttributeName=TTL' \
          --endpoint-url http://dynamodb-local:8000 \
          2>/dev/null || echo 'TTL already enabled on traces'

        echo 'DynamoDB tables created successfully!'
        aws dynamodb list-tables --endpoint-url http://dynamodb-local:8000
      "

  # Prism Dashboard (with DynamoDB)
  prism:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prism-app
    ports:
      - "5003:5003"
      - "4317:4317"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - DYNAMODB_SERVICE_URL=http://dynamodb-local:8000
      - DYNAMODB_LOGS_TABLE=prism-logs
      - DYNAMODB_METRICS_TABLE=prism-metrics
      - DYNAMODB_TRACES_TABLE=prism-traces
      - DYNAMODB_TTL_DAYS=7
      - AWS_REGION=us-east-1
    depends_on:
      dynamodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  dynamodb-data:
